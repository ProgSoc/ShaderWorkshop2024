{"name":"4. Post Processing","goals":[],"shaders":[{"filename":"main.vert","contents":"#version 300 es\n\nin vec3 position;\nin vec3 normal;\nin vec2 uv;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 projection;\n\nuniform mat4 lightView;\nuniform mat4 lightProjection;\n\nout vec3 vNormal;\nout vec2 vUv;\nout vec4 vPos;\nout vec4 vLightUv;\n\nvoid main() {\n    vUv = uv;\n    vNormal = (model * vec4(normal, 0.)).xyz;\n    vPos = model * vec4(position, 1.);\n    vLightUv = lightProjection * lightView * vPos;\n    gl_Position = projection * view * vPos;\n}"},{"filename":"main.frag","contents":"#version 300 es\n\nprecision highp float;\n\nin vec3 vNormal;\nin vec2 vUv;\nin vec4 vPos;\nin vec4 vLightUv;\n\nout vec4 FragColor;\n\nuniform sampler2D shadowMap;\nuniform float time;\n\nfloat shadow() {\n    // The projected coordinates using the light source camera's\n    // projection and view matrix. These are projected in the vertex shader.\n    vec3 projCoords = vLightUv.xyz / vLightUv.w;\n    // Convert to screen space\n    projCoords = projCoords * 0.5 + 0.5;\n\n    // Loop around the area and average to soften the shadows\n    #define SHADOW_MAP_SAMPLES 7\n    float shadow = 0.;\n    float totalWeight = 0.;\n    for (int x = -SHADOW_MAP_SAMPLES; x < SHADOW_MAP_SAMPLES; x++) {\n        for (int y = -SHADOW_MAP_SAMPLES; y < SHADOW_MAP_SAMPLES; y++) {\n            float r2 = float(x * x + y * y);\n            float R2 = float(SHADOW_MAP_SAMPLES * SHADOW_MAP_SAMPLES);\n\n            // Create a circle blur kernel\n            if (r2 > R2) continue;\n\n            // give less weight to more distant fragments\n            float distWeight = 1. - (r2 / R2);\n\n            float currentDepth = projCoords.z;\n            vec2 offset = vec2(x, y) * 0.005;\n\n            // Sample from the depth map using the projected coordinates\n            float closestDepth = texture(shadowMap, projCoords.xy + offset).r;\n            bool inShadow = currentDepth - 0.0004 > closestDepth;\n\n            shadow += (inShadow ? 0.4 : 1.0) * distWeight; \n            totalWeight += distWeight;\n        }\n    }\n    shadow /= totalWeight;\n\n    return shadow;\n}\n\nvoid main() {\n    vec3 normal = normalize(vNormal);\n    vec3 ambient = vec3(0.1, 0.2, 1);\n    vec3 sun = vec3(-1, -1, -1);\n\n    float angle = clamp(-dot(normalize(normal), normalize(sun)), 0., 1.);\n    float diffuseBrightness = angle;\n\n    vec3 cameraPosition = vec3(-8., 4., 8.);\n\n    vec3 viewDirection = normalize(vPos.xyz - cameraPosition);\n    vec3 reflectionDirection = normalize(2. * dot(normal, sun) * normal - sun);\n    float specularAngle = clamp(dot(viewDirection, reflectionDirection), 0., 1.);\n    vec3 specular = vec3(pow(specularAngle, 20.));\n\n    float F0 = 0.2;\n    float F = F0 + (1. - F0) * pow((1. - max(-dot(normal, viewDirection), 0.)), 3.);\n\n    float edgeLighting = (F) * 0.3;\n\n    vec3 final = mix((ambient) * diffuseBrightness, ambient, 0.1) \n        + specular * F * 3.\n        + edgeLighting;\n\n    final *= shadow();\n    \n    FragColor = vec4(final, 1.);\n}"},{"filename":"empty.frag","contents":"#version 300 es\n\nprecision highp float;\n\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = vec4(1.);\n}"},{"filename":"shadowProj.vert","contents":"#version 300 es\n\nin vec3 position;\nin vec3 normal;\nin vec2 uv;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 projection;\n\nvoid main() {\n    vec4 vPos = model * vec4(position, 1.);\n    gl_Position = projection * view * vPos;\n}"},{"filename":"screen.vert","contents":"#version 300 es\n\nin vec4 position;\nout vec2 vUv;\n\nvoid main(void) {\n    vUv = (position.xy + 1.0)/2.0;\n    gl_Position = position;\n}"},{"filename":"post.frag","contents":"#version 300 es\n\nprecision highp float;\n\nin vec2 vUv;\nout vec4 FragColor;\n\nuniform sampler2D tex;\nuniform vec2 screenSize;\nuniform float time;\n\nvoid main() {\n    vec2 gb = texture(tex, vUv).gb;\n    float r = texture(tex, vUv - vec2(1./screenSize.x, 0.)).r;\n    FragColor = vec4(r, gb, 1.);\n}"}],"pipelineGraph":{"nodes":[{"id":"0.4025455024919875","type":"uniform","position":{"x":6,"y":-75},"data":{"label":"uniform node","type":"projection","fov":45,"near":0.1,"far":100},"origin":[0.5,0],"measured":{"width":161,"height":160},"selected":false,"dragging":false},{"id":"0.5984985949643993","type":"uniform","position":{"x":-94,"y":350},"data":{"label":"uniform node","type":"view","x":-8,"y":4,"z":5,"targetX":-1,"targetY":1,"targetZ":-0.7,"upX":0,"upY":1,"upZ":0},"origin":[0.5,0],"measured":{"width":161,"height":331},"selected":false,"dragging":false},{"id":"0.6788965243760299","type":"shader","position":{"x":711,"y":50},"data":{"label":"shader node","shaderSourceFileName":"main.vert"},"origin":[0.5,0],"measured":{"width":221,"height":153},"selected":false,"dragging":false},{"id":"0.6883502327990607","type":"gl-program","position":{"x":1341,"y":200},"data":{"label":"gl-program node"},"origin":[0.5,0],"measured":{"width":131,"height":86},"selected":false,"dragging":false},{"id":"0.4656143492836935","type":"shader","position":{"x":886,"y":225},"data":{"label":"shader node","shaderSourceFileName":"main.frag"},"origin":[0.5,0],"measured":{"width":221,"height":104},"selected":false,"dragging":false},{"id":"0.07296797580900671","type":"uniform","position":{"x":281,"y":475},"data":{"label":"uniform node","type":"time"},"origin":[0.5,0],"measured":{"width":161,"height":73},"selected":false,"dragging":false},{"id":"0.3762754214092061","type":"macro","position":{"x":417,"y":675},"data":{"label":"macro node","name":"scene"},"origin":[0.5,0],"measured":{"width":133,"height":111},"selected":false,"dragging":false},{"id":"0.5024430674378506","type":"uniform","position":{"x":206,"y":-50},"data":{"label":"uniform node","type":"translation","x":0},"origin":[0.5,0],"measured":{"width":161,"height":160},"selected":false,"dragging":false},{"id":"0.15950623553268528","type":"gl-program","position":{"x":941,"y":675},"data":{"label":"gl-program node"},"origin":[0.5,0],"measured":{"width":131,"height":86},"selected":false,"dragging":false},{"id":"0.9874474568613121","type":"framebuffer","position":{"x":1138.5,"y":600},"data":{"label":"framebuffer node","scaleFactor":1,"resizeMode":"Nearest","isDepthMap":true},"origin":[0.5,0],"measured":{"width":126,"height":109},"selected":false,"dragging":false},{"id":"0.44183083112787824","type":"shader","position":{"x":786,"y":600},"data":{"label":"shader node","shaderSourceFileName":"empty.frag"},"origin":[0.5,0],"measured":{"width":221,"height":71},"selected":false,"dragging":false},{"id":"0.16182435250483107","type":"shader","position":{"x":761,"y":775},"data":{"label":"shader node","shaderSourceFileName":"shadowProj.vert"},"origin":[0.5,0],"measured":{"width":221,"height":120},"selected":false,"dragging":false},{"id":"0.44483423891033413","type":"uniform","position":{"x":256,"y":1000},"data":{"label":"uniform node","type":"view","fov":45,"near":0.1,"far":100,"x":4,"y":4,"z":4,"targetX":0,"targetY":0,"targetZ":0,"upX":0,"upY":1,"upZ":0},"origin":[0.5,0],"measured":{"width":161,"height":331},"selected":false,"dragging":false},{"id":"0.42358799011209314","type":"uniform","position":{"x":256,"y":800},"data":{"label":"uniform node","type":"projection","fov":74,"near":0.1,"far":100},"origin":[0.5,0],"measured":{"width":161,"height":160},"selected":false,"dragging":false},{"id":"0.5638351826652657","type":"framebuffer","position":{"x":1563,"y":-50},"data":{"label":"framebuffer node","scaleFactor":2,"resizeMode":"Linear"},"origin":[0.5,0],"measured":{"width":126,"height":109},"selected":false,"dragging":false},{"id":"0.5163349535824284","type":"macro","position":{"x":2116.5,"y":150},"data":{"label":"macro node","name":"screen pass"},"origin":[0.5,0],"measured":{"width":133,"height":131},"selected":false,"dragging":false},{"id":"0.5895737960536305","type":"shader","position":{"x":1835.5,"y":125},"data":{"label":"shader node","shaderSourceFileName":"post.frag"},"origin":[0.5,0],"measured":{"width":221,"height":120},"selected":false,"dragging":false},{"id":"0.3525823623470514","type":"window","position":{"x":2343,"y":225},"data":{"label":"window node"},"origin":[0.5,0],"measured":{"width":86,"height":40},"selected":false,"dragging":false},{"id":"0.6450275665217622","type":"uniform","position":{"x":1605.5,"y":375},"data":{"label":"uniform node","type":"time"},"origin":[0.5,0],"measured":{"width":161,"height":73},"selected":false,"dragging":false},{"id":"0.5227748928253866","type":"uniform","position":{"x":1580.5,"y":225},"data":{"label":"uniform node","type":"window size"},"origin":[0.5,0],"measured":{"width":161,"height":73},"selected":false,"dragging":false}],"edges":[{"source":"0.4025455024919875","sourceHandle":"__output","target":"0.6788965243760299","targetHandle":"projection","id":"xy-edge__0.4025455024919875__output-0.6788965243760299projection","selected":false},{"source":"0.5984985949643993","sourceHandle":"__output","target":"0.6788965243760299","targetHandle":"view","id":"xy-edge__0.5984985949643993__output-0.6788965243760299view","selected":false},{"source":"0.6788965243760299","sourceHandle":"__output","target":"0.6883502327990607","targetHandle":"vert","id":"xy-edge__0.6788965243760299__output-0.6883502327990607vert","selected":false},{"source":"0.4656143492836935","sourceHandle":"__output","target":"0.6883502327990607","targetHandle":"frag","id":"xy-edge__0.4656143492836935__output-0.6883502327990607frag","selected":false},{"source":"0.07296797580900671","sourceHandle":"__output","target":"0.4656143492836935","targetHandle":"time","id":"xy-edge__0.07296797580900671__output-0.4656143492836935time","selected":false},{"source":"0.3762754214092061","target":"0.6883502327990607","targetHandle":"geometry","id":"xy-edge__0.3762754214092061-0.6883502327990607geometry","selected":false},{"source":"0.5024430674378506","sourceHandle":"__output","target":"0.6788965243760299","targetHandle":"model","id":"xy-edge__0.5024430674378506__output-0.6788965243760299model","selected":false},{"source":"0.3762754214092061","target":"0.15950623553268528","targetHandle":"geometry","id":"xy-edge__0.3762754214092061-0.15950623553268528geometry","selected":false},{"source":"0.15950623553268528","sourceHandle":"__output","target":"0.9874474568613121","targetHandle":"in","id":"xy-edge__0.15950623553268528__output-0.9874474568613121in","selected":false},{"source":"0.44183083112787824","sourceHandle":"__output","target":"0.15950623553268528","targetHandle":"frag","id":"xy-edge__0.44183083112787824__output-0.15950623553268528frag","selected":false},{"source":"0.16182435250483107","sourceHandle":"__output","target":"0.15950623553268528","targetHandle":"vert","id":"xy-edge__0.16182435250483107__output-0.15950623553268528vert","selected":false},{"source":"0.44483423891033413","sourceHandle":"__output","target":"0.16182435250483107","targetHandle":"view","id":"xy-edge__0.44483423891033413__output-0.16182435250483107view","selected":false},{"source":"0.9874474568613121","sourceHandle":"out","target":"0.4656143492836935","targetHandle":"shadowMap","id":"xy-edge__0.9874474568613121out-0.4656143492836935shadowMap","selected":false},{"source":"0.42358799011209314","sourceHandle":"__output","target":"0.16182435250483107","targetHandle":"projection","id":"xy-edge__0.42358799011209314__output-0.16182435250483107projection","selected":false},{"source":"0.42358799011209314","sourceHandle":"__output","target":"0.6788965243760299","targetHandle":"lightProjection","id":"xy-edge__0.42358799011209314__output-0.6788965243760299lightProjection","selected":false},{"source":"0.44483423891033413","sourceHandle":"__output","target":"0.6788965243760299","targetHandle":"lightView","id":"xy-edge__0.44483423891033413__output-0.6788965243760299lightView","selected":false},{"source":"0.6883502327990607","sourceHandle":"__output","target":"0.5638351826652657","targetHandle":"in","id":"xy-edge__0.6883502327990607__output-0.5638351826652657in","selected":false},{"source":"0.5895737960536305","sourceHandle":"__output","target":"0.5163349535824284","targetHandle":"frag","id":"xy-edge__0.5895737960536305__output-0.5163349535824284frag","selected":false},{"source":"0.5638351826652657","sourceHandle":"out","target":"0.5895737960536305","targetHandle":"tex","id":"xy-edge__0.5638351826652657out-0.5895737960536305tex","selected":false},{"source":"0.5163349535824284","target":"0.3525823623470514","targetHandle":"in","id":"xy-edge__0.5163349535824284-0.3525823623470514in","selected":false},{"source":"0.6450275665217622","sourceHandle":"__output","target":"0.5895737960536305","targetHandle":"time","id":"xy-edge__0.6450275665217622__output-0.5895737960536305time","selected":false},{"source":"0.5227748928253866","sourceHandle":"__output","target":"0.5895737960536305","targetHandle":"screenSize","id":"xy-edge__0.5227748928253866__output-0.5895737960536305screenSize"}]},"macros":[{"name":"scene","inputLabels":[],"graph":{"nodes":[{"id":"0.7254421557490351","type":"output","data":{},"position":{"x":325,"y":100},"measured":{"width":150,"height":49},"selected":false,"dragging":false},{"id":"0.5270824240425167","type":"inputs","data":{"inputLabels":{}},"position":{"x":-550,"y":-150},"measured":{"width":161,"height":61},"selected":false,"dragging":false},{"id":"0.8558785786199814","type":"geometry","position":{"x":104,"y":-175},"data":{"label":"geometry node","type":"Model","uniformOverrides":["model"],"modelSrc":"cube.obj"},"origin":[0.5,0],"measured":{"width":207,"height":170},"selected":false,"dragging":false},{"id":"0.26990307538008973","type":"geometry","position":{"x":104,"y":0},"data":{"label":"geometry node","type":"Model","uniformOverrides":["model"],"modelSrc":"sphere.obj"},"origin":[0.5,0],"measured":{"width":207,"height":170},"selected":false,"dragging":false},{"id":"0.2547230567857732","type":"geometry","position":{"x":104,"y":175},"data":{"label":"geometry node","type":"Model","uniformOverrides":["model"],"modelSrc":"monkey.obj"},"origin":[0.5,0],"measured":{"width":207,"height":170},"selected":false,"dragging":false},{"id":"0.4924650761530207","type":"uniform","position":{"x":-169,"y":-175},"data":{"label":"uniform node","type":"translation","y":0,"z":-2,"x":0},"origin":[0.5,0],"measured":{"width":161,"height":160},"selected":false,"dragging":false},{"id":"0.5557933679953182","type":"uniform","position":{"x":-169,"y":0},"data":{"label":"uniform node","type":"translation","y":2,"x":-3,"z":-1},"origin":[0.5,0],"measured":{"width":161,"height":160},"selected":false,"dragging":false},{"id":"0.7648602964324309","type":"uniform","position":{"x":-169,"y":175},"data":{"label":"uniform node","type":"translation","x":0.5,"z":1,"y":1.4},"origin":[0.5,0],"measured":{"width":161,"height":160},"selected":false,"dragging":false}],"edges":[{"source":"0.2547230567857732","sourceHandle":"__output","target":"0.7254421557490351","targetHandle":"in","id":"xy-edge__0.09229821433620944__output-0in","selected":false},{"source":"0.26990307538008973","sourceHandle":"__output","target":"0.7254421557490351","targetHandle":"in","id":"xy-edge__0.7092132330014198__output-0in","selected":false},{"source":"0.8558785786199814","sourceHandle":"__output","target":"0.7254421557490351","targetHandle":"in","id":"xy-edge__0.15687022720788857__output-0in","selected":false},{"source":"0.4924650761530207","sourceHandle":"__output","target":"0.8558785786199814","targetHandle":"model","id":"xy-edge__0.835459651683528__output-0.25163250135530624model","selected":false},{"source":"0.5557933679953182","sourceHandle":"__output","target":"0.26990307538008973","targetHandle":"model","id":"xy-edge__0.29017415420774983__output-0.3794801820851914model","selected":false},{"source":"0.7648602964324309","sourceHandle":"__output","target":"0.2547230567857732","targetHandle":"model","id":"xy-edge__0.2229827157283073__output-0.9394445600187695model","selected":false}]}},{"name":"screen pass","inputLabels":["frag"],"graph":{"nodes":[{"id":"0","type":"output","data":{},"position":{"x":475,"y":0},"measured":{"width":150,"height":49},"selected":false,"dragging":false},{"id":"1","type":"inputs","data":{"inputLabels":{}},"position":{"x":0,"y":-25},"measured":{"width":161,"height":76},"selected":false,"dragging":false},{"id":"0.9289588018011166","type":"geometry","position":{"x":140.5,"y":100},"data":{"label":"geometry node","type":"Screen Quad","uniformOverrides":[]},"origin":[0.5,0],"measured":{"width":131,"height":121},"selected":false,"dragging":false},{"id":"0.21751759114536062","type":"gl-program","position":{"x":340.5,"y":-25},"data":{"label":"gl-program node"},"origin":[0.5,0],"measured":{"width":131,"height":86},"selected":false,"dragging":false},{"id":"0.2873844403680341","type":"shader","position":{"x":110.5,"y":-125},"data":{"label":"shader node","shaderSourceFileName":"screen.vert"},"origin":[0.5,0],"measured":{"width":221,"height":71},"selected":false,"dragging":false}],"edges":[{"source":"0.9289588018011166","sourceHandle":"__output","target":"0.21751759114536062","targetHandle":"geometry","id":"xy-edge__0.9289588018011166__output-0.21751759114536062geometry","selected":false},{"source":"0.21751759114536062","sourceHandle":"__output","target":"0","targetHandle":"in","id":"xy-edge__0.21751759114536062__output-0in","selected":false},{"source":"1","sourceHandle":"frag","target":"0.21751759114536062","targetHandle":"frag","id":"xy-edge__1frag-0.21751759114536062frag","selected":false},{"source":"0.2873844403680341","sourceHandle":"__output","target":"0.21751759114536062","targetHandle":"vert","id":"xy-edge__0.2873844403680341__output-0.21751759114536062vert","selected":false}]}}]}